<!html>
<head>
    <link rel="stylesheet" type"text/css" href="./css/entrycss.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
</head>
<body>
    <header>
        <img id = "logo" src="./img/logo" ></img>
        <div style = "overflow: auto;">
            <div class="header-tag" id = "devices">
                <a href="./devices" class = "link"><p>devices<p></a>
            </div>
            <div class="header-tag" id = "login">
                <a href="./login.html" class = "link"><p>log in</p></a>
            </div>
            <div class="header-tag" id = "logout">
                <a href="./login.html" class = "link"><p>log out</p></a>
            </div>
            <div class="header-tag" id = "signup">
                <a href="./signup.html" class = "link"><p>sign up</p></a>
            </div>
            <div class="header-tag" id = "help">
                <a href="./help.html" class = "link"><p>help</p></a>
            </div>
	    </div>
    </header>
    <main>
        <div id = "url-form" style = "width: 60%; margin:auto; margin-top: 150px;">
            <input type = "text" value= "URL" id = "urlbar" style = "width: 60%; height: 35px; margin-left: auto; margin-right: auto; padding: 0px">
            <input type = "submit" value = "get Song" id = "getsong" style = "height: 35px;">
        </div>
        <div id = "error-box">
            <p id = "login-error"></p>
        </div>
	</main>
    <footer>
        <div style = "float:left; width:60%;">
            <p>that is how it works!</p>
        </div>
        <div style = "float:right;">
            <p>contact info</p>
        </div>
    </footer>
    <script type = "text/javascript">
        function loginMode(){ //TODO check cookies authentications
            console.log("loginMode")
            document.getElementById("devices").style.display = "block"
            document.getElementById("logout").style.display = "block"
            document.getElementById("login").style.display = "none"
            document.getElementById("signup").style.display = "none"
	    }
        function logoutMode(){
            console.log("logoutMode")
            document.getElementById("devices").style.display = "none";
            document.getElementById("logout").style.display = "none";
            document.getElementById("login").style.display = "block"
            document.getElementById("signup").style.display = "block"
        }
        function getSong(){
            var v = document.getElementById("urlbar").value;
            // below you will download song from givin user url, before force dowload
            // you should be sure that download will work. 
            // if user has registered devices pop up a hint
            // check if video available by checking response size
            // check if it list or song if list find a way for getting the song
            if(!(v.startsWith("https://www.youtube.com/watch?v=")||
                v.startsWith("http://www.youtube.com/watch?v=")||
                v.startsWith("www.youtube.com/watch?v=")||
                v.startsWith("youtube.com/watch?v="))) {
		        alert("bad URL")
            }
            else{
                updateAuth()
                window.location.href = "http://92.222.80.85:8080/sfp/getsong?"+
                "forcedownload=true&mobilesdownload=true&name="+name+"&pass="+pass+"&url="+v.split("?v=")[1]
            }
        }
        function getCookie(cname){
            cookies = document.cookie.split(';')
            console.log("cookies length  "+ cookies.length)
            for(i = 0; i < cookies.length; i++){
                console.log("cookies"+i+" : "+cookies[i]);
                keyValuePair = cookies[i].split('=')
                if(keyValuePair[0].trim() == cname){
                    return keyValuePair[1].trim()
                }
            }
            return -1 
        }
        function init(){
            cookies = document.cookie.split(';')
            lastLogedUserIndex = getCookie('lastlogeduserindex')
            lastLogedUserName = getCookie('name'+lastLogedUserIndex)
            lastLogedUserPass = getCookie('pass'+lastLogedUserIndex)
            if(lastLogedUserPass == -1 || lastLogedUserName == -1){
                logoutMode()
                return
            }
            checkAuthRequest = new XMLHttpRequest()
            checkAuthRequest.onreadystatechange = function(){
                console.log("ready state change")
                if(this.status == 401){
                    window.location.href = "http://92.222.80.85:8080/sfp/login.html"
                }
                else if(this.status == 200){    
                    loginMode() 
                }
            }
            checkAuthRequest.open('GET', "http://92.222.80.85:8080/sfp/getsong?"+
                "checkuser=true&name="+lastLogedUserName+"&pass="+lastLogedUserPass)
            checkAuthRequest.send()
        }init()
        document.getElementById("logout").addEventListener('click', logoutMode)
        document.getElementById("getsong").addEventListener('click', getSong)
    </script>
</body>
