<!html>
<head>
    <link rel="stylesheet" type"text/css" href="./css/template.css"/>
    <link rel="stylesheet" type"text/css" href="./css/index-extra.css"/>    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <meta name="viewport" content = "device-width, initial-scale=1">
</head>
<body>
    <header>
        <img id = "logo" src="./img/logo" ></img>
        <div style = "float: right;display: flex;">
            <div class="header-tag" id = "devices">
                <a href="./devices.html" class = "link"><p>Devices<p></a>
            </div>
            <div class="header-tag" id = "login">
                <a href="./login.html" class = "link"><p>Log In</p></a>
            </div>
            <div class="header-tag" id = "logout">
                <a href="./login.html" class = "link"><p>Log Out</p></a>
            </div>
            <div class="header-tag" id = "signup">
                <a href="./signup.html" class = "link"><p>Sign Up</p></a>
            </div>
            <div class="header-tag" id = "help">
                <a href="./guide.html" class = "link"><p>Guide</p></a>
            </div>
	    </div>
    </header>
    <main>
        <div id = "url-form" style = "width: 80%; margin:auto; padding-top: 25%;">
            <input type = "text" value= "URL" id = "urlbar">
            <input type = "submit" value = "get Song" id = "getsong" style = "height: 35px;">
        </div>
        <div id = "error-box">
            <p id = "login-error"></p>
        </div>
	</main>
    <footer>
        <div style = "float: left; width:50%;">
            <p>download any youtube or vimeo (high quality audio song) to your mobiles or local device using any other computer or mobile, sign up free account, download mobile app on your target mobiles, copy song url, and enjoy art!</p>
        </div>
        <div style = "float:right;">
            <p>contact info</p>
        </div>
    </footer>
    <script type = "text/javascript">
        cookies = document.cookie.split(';')
        lastLogedUserIndex = getCookie('lastlogeduserindex')
        lastLogedUserName = getCookie('name'+lastLogedUserIndex)
        lastLogedUserPass = getCookie('pass'+lastLogedUserIndex)
        function loginMode(){ //TODO check cookies authentications
            console.log("loginMode")
            document.getElementById("devices").style.display = "block"
            document.getElementById("logout").style.display = "block"
            document.getElementById("login").style.display = "none"
            document.getElementById("signup").style.display = "none"
	    }
        function logoutMode(){
            console.log("logoutMode")
            document.getElementById("devices").style.display = "none";
            document.getElementById("logout").style.display = "none";
            document.getElementById("login").style.display = "block"
            document.getElementById("signup").style.display = "block"
        }
        function getSong(){
            var v = document.getElementById("urlbar").value;
            // below you will download song from givin user url, before force dowload
            // you should be sure that download will work. 
            // if user has registered devices pop up a hint
            // check if video available by checking response size
            // check if it list or song if list find a way for getting the song
            if(!(v.startsWith("https://www.youtube.com/watch?v=")||
                v.startsWith("http://www.youtube.com/watch?v=")||
                v.startsWith("www.youtube.com/watch?v=")||
                v.startsWith("youtube.com/watch?v="))) {
		        alert("bad URL")
            }
            else{
                name = getCookie('name'+lastLogedUserIndex)
                pass = getCookie('pass'+lastLogedUserIndex)
                window.location.href = "http://92.222.80.85:8080/sfp/getsong?"+
                "forcedownload=true&mobilesdownload=true&name="+name+"&pass="+pass+"&url="+v.split("?v=")[1]
            }
        }
        function getCookie(cname){
            cookies = document.cookie.split(';')
            console.log("cookies length  "+ cookies.length)
            for(i = 0; i < cookies.length; i++){
                console.log("cookies"+i+" : "+cookies[i]);
                keyValuePair = cookies[i].split('=')
                if(keyValuePair[0].trim() == cname){
                    return keyValuePair[1].trim()
                }
            }
            return -1 
        }
        function init(){
            if(lastLogedUserPass == -1 || lastLogedUserName == -1){
                logoutMode()
                return
            }
            checkAuthRequest = new XMLHttpRequest()
            checkAuthRequest.onreadystatechange = function(){
                console.log("ready state change")
                if(this.status == 401){
                    window.location.href = "http://92.222.80.85:8080/sfp/login.html"
                }
                else if(this.status == 200){    
                    loginMode() 
                }
            }
            checkAuthRequest.open('GET', "http://92.222.80.85:8080/sfp/getsong?"+
                "checkuser=true&name="+lastLogedUserName+"&pass="+lastLogedUserPass)
            checkAuthRequest.send()
        }init()
        document.getElementById("logout").addEventListener('click', logoutMode)
        document.getElementById("getsong").addEventListener('click', getSong)
    </script>
</body>
