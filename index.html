<!html>
<head>
    <link rel="stylesheet" type"text/css" href="./css/entrycss.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
</head>
<body>
    <header>
        <img id = "logo" src="./img/logo"  style = "float: left; height: 50px; width: 60px;"></img>
        <div style = "overflow: auto;">
            <div class="header-tag" id = "devices">
                <a href="./devices" class = "link"><p>devices<p></a>
            </div>
            <div class="header-tag" id = "login">
                <a href="./login.html" class = "link"><p>log in</p></a>
            </div>
            <div class="header-tag" id = "logout">
                <a href="./login.html" class = "link"><p>log out</p></a>
            </div>
            <div class="header-tag" id = "signup">
                <a href="./signup.html" class = "link"><p>sign up</p></a>
            </div>
            <div class="header-tag" id = "help">
                <a href="./help.html" class = "link"><p>help</p></a>
            </div>
	    </div>
    </header>
    <main>
        <img id="song-img" style = "display: none; margin:auto; margin-top: 80px;padding-top:10px; width: 150px; height: 150px;"></img>
        <div id = "url-form" style = "margin:auto;width: 440px;margin-top: 30px;">
            <input type = "text" value= "URL" id = "urlbar" width = "200px" size = 40>
            <input type = "submit" value = "get Song" onClick="getSong()">
        </div>
        <div id = "error-box">
            <p id = "login-error"></p>
	</div>       
        <div id="devices-panel" style = "margin:auto;display: block;width:200px;">
            <!-- if num of devices > 1 i should generate checkbox inputs with submit button-->
            <p id = "panel-par">choose set of your devices to download to</p>
            <form style = "margin:auto;">
                <input type = "submit" value = "download" id = "download-btn">
            </form>
        </div>
        <div id = "no-mobiles" style = "overflow:auto;margin:auto;margin-top: 10px;width: 300px;display: none; background-color: #b8b4b4;">
            <p id = "no-mobiles-p" style = "margin:auto;">Error: user had no mobiles!</p>
        </div>
    </main>
    <footer style = "overflow:auto;display:inline;position:absolute;width:100%;height:100px;background-color:#5f5f5f;box-shadow: 0 -5px 5px #888888">
        <div style = "float:left; width:60%;">
            <p>that is how it works!</p>
        </div>
        <div style = "float:right;">
            <p>contact info</p>
        </div>
    </footer>
    <script type = "text/javascript">
        function loginMode(){ //TODO check cookies authentications
            console.log("loginMode")
            document.getElementById("devices").style.display = "block"
            document.getElementById("logout").style.display = "block"
            document.getElementById("login").style.display = "none"
            document.getElementById("signup").style.display = "none"
            document.getElementById("mobile-download-btn").style.display= "block"
	}
        function logoutMode(){
            console.log("logoutMode")
            document.getElementById("devices").style.display = "none";
            document.getElementById("logout").style.display = "none";
            document.getElementById("login").style.display = "block"
            document.getElementById("signup").style.display = "block"
            document.getElementById("mobile-download-btn").style.display= "none";            
        }
        function getSong(){
            devicesInfo = getDevicesNum()
            // should be jason object of nested array            

            if(devicesNum == 0){
                downloadSongLocally()
                loginError = document.getElementById("error-box")
                if(!loginError.childNodes[0]){
                    loginError.appendChild(document.createTextNode(
                    "note! you didn't have registered devices yet for further <a href = "./help.html">information</a>")
                } else{
                    loginError.replaceChild(document.createTextNode(
                    "note! you didn't have registered devices yet for further <a href = "./help.html">information</a>"),
                    loginError.childNodes[0])
                }
           } else{
               
           }
        }
        function downloadSongLocally(){
            var v = document.getElementById("urlbar").value;
            if(!(v.startsWith("https://www.youtube.com/watch?v=")||
                v.startsWith("http://www.youtube.com/watch?v=")||
                v.startsWith("www.youtube.com/watch?v=")||
                v.startsWith("youtube.com/watch?v="))) {
		alert("bad URL")
                // TODO check if video available by checking response size
                // check if it list or song if list find a way for getting the song
            }
            else{
                window.location.href = "http://92.222.80.85:8080/sfp/getsong?"+
                "signup=false&login=false&download=true&pass=null&name=null&browser=true&url="+v.split("?v=")[1]
            }
        }
        function getCookie(cname){
            cookies = document.cookie.split(';')
            console.log("cookies length  "+ cookies.length)
            for(i = 0; i < cookies.length; i++){
                console.log("cookies"+i+" : "+cookies[i]);
                keyValuePair = cookies[i].split('=')
                if(keyValuePair[0].trim() == cname){
                    return keyValuePair[1].trim()
                }
            }
            return -1 
        }
        function init(){
            cookies = document.cookie.split(';')
            lastLogedUserIndex = getCookie('lastlogeduserindex')
            lastLogedUserName = getCookie('name'+lastLogedUserIndex)
            lastLogedUserPass = getCookie('pass'+lastLogedUserIndex)
            if(lastLogedUserPass == -1 || lastLogedUserName == -1){
                logoutMode()
                return
            }
            checkAuthRequest = new XMLHttpRequest()
            checkAuthRequest.onreadystatechange = function(){
                console.log("ready state change")
                if(this.status == 401){
                    window.location.href = "http://92.222.80.85:8080/sfp/login.html"
                }
                else if(this.status == 200){    
                    loginMode() 
                }
            }
            checkAuthRequest.open('GET', "http://92.222.80.85:8080/sfp/getsong?login=true&signup=false&checkuser=true&download=false&browser=true&url=nullurl&name="+lastLogedUserName+"&pass="+lastLogedUserPass)
            checkAuthRequest.send()
        }init()
        document.getElementById("logout").addEventListener('click', logoutMode)    
    </script>
</body>
